<?php/** * Created by PhpStorm. * User: Baymax * Date: 2017/11/24 * Time: 14:09 */namespace app\Admin\controller;use think\Controller;use think\Session;use think\Request;use think\Validate;use app\Admin\model\AdminUser;use app\Common\Controller\AuthAdminInterManage;class AdminUserManage extends AuthAdminInterManage{    function objectarray(&$object) {        $object =  json_decode( json_encode( $object),true);        return  $object;    }    /**     * @param uid array     * 获取管理员列表     */    public function admin_list(){        $all = Request::instance()->post();        $user = model('AdminUser');        if (isset($all['sortName'])){            $name = $all['sortName'];        }else{            $name = 'reg_time';        }        if (isset($all['searchText'])){            $text = $all['searchText'];        }else{            $text = '';        }        //多个字段模糊查找        $where['name|login_name']=array('like','%'.$text.'%');        //过滤字段模糊查找        $list = $user->field('pwd,login_info',true)->where($where)->order($name, $all['sortOrder'])->paginate($all['pageSize'],false,[            'page' => $all['pageNumber'],        ]);        $auth = new \Auth\Auth();//        foreach( $list as $key => $value ){//            if( is_array( $value ) )//                $array[ $key ] = arrayToObject( $value );//            var_dump(arrayToObject( $value ));//        }        $list = $this->objectarray($list);        //var_dump($list['data']);        //var_dump(key($list));        //$result = $auth->getGroups($list['data'][1]["uid"]);        foreach($list['data'] as $key => $value){            $result = $auth->getGroups($value["uid"]);            $list['data'][$key]['group'] = $result;        }        //var_dump( $result);        return json($list);    }    /**     * @param uid array     * 添加管理员接口     */    public function add_admin(){        $all = Request::instance()->post();        $result   = array('status' => false, 'msg' => "");        $rule = [            'name'  => 'require',            'login_name'   => 'require',            'pwd' => ['regex'=>'/^(?![A-Z]+$)(?![a-z]+$)(?!\d+$)(?![\W_]+$)\S{6,16}$/']        ];        $msg = [            'name.require'  => '用户名不得为空',            'login_name.require' => '账号是必填的',            'pwd.regex'  => '密码强度不够',        ];        $validate = new Validate($rule, $msg);        $msg = $validate->check($all);        //匹配规则，如果有问题则返回输出信息        if(!$msg){            $result['status'] = 0;            $result['msg'] = $validate->getError();            return json($result);        }        $AdminUser = AdminUser::get(['login_name' => $all['login_name']]);        if($AdminUser){            $result['status'] = 0;            $result['msg'] = '用户名已存在！';            return json($result);        }        $register_time = date('Y-m-d H:i:s');        $AdminUser = AdminUser::create([            'name'  =>  $all['name'],            'login_name' =>  $all['login_name'],            'pwd' =>  authcode($all['pwd'],'mysys'),            'reg_time' => $register_time,            'login_count' => 0,            'status' => "1",        ]);        if($AdminUser){            $result['status'] = 1;            $result['msg'] = '添加成功！';            return json($result);        }else{            $result['status'] = 0;            $result['msg'] = '添加失败！';            return json($result);        }    }    /**     * @param uid array     * 删除管理员接口     */    public function del_admin(){        $result   = array('status' => false, 'msg' => "");        $all = Request::instance()->post();        $user = model('AdminUser');        if(sizeof($all['uid'])){            $msg = array();            //循环删除            for($i = 0; $i<sizeof($all['uid']);$i++){                $uid = $all['uid'][$i];                //软删除较为麻烦                //$user->destroy($uid);                $del_result = $user -> where('uid',$uid)->delete();                if($del_result == false){                    array_push($msg,$uid);//添加元素                }            }            //判断删除中否出现问题            if(sizeof($msg)){                $result['status'] = 0;                $result['msg'] = 'UID为【'.implode(',',$msg).'】的数据删除失败！';                return json($result);            }else{                $result['status'] = 1;                $result['msg'] = '全部删除成功！';                return json($result);            }        }else{            //空传判断            $result['status'] = 0;            $result['msg'] = '请先选择要删除的行！';            return json($result);        }    }    /**     * @param uid array     * 编辑管理员接口     */    public function edit_admin($id){        $all = Request::instance()->post();        $result = array('status' => false, 'msg' => "");        $user = model('AdminUser');        $rule = [            'name'  => 'require',            'login_name'   => 'require',        ];        $msg = [            'name.require'  => '用户名不得为空',            'login_name.require' => '账号是必填的',        ];        $validate = new Validate($rule, $msg);        $msg = $validate->check($all);        //匹配规则，如果有问题则返回输出信息        if(!$msg){            $result['status'] = 0;            $result['msg'] = $validate->getError();            return json($result);        }        $AdminUser = AdminUser::get(['login_name' => $all['login_name']]);        if($AdminUser){            $result['status'] = 0;            $result['msg'] = '用户名已存在！';            return json($result);        }        $edit_result = $user -> where('uid='.$id) ->update([            'name' => $all['name'],            'login_name' => $all['login_name'],        ]);        if($edit_result){            $result['status'] = 1;            $result['msg'] = '修改成功！';            return json($result);        }else{            $result['status'] = 0;            $result['msg'] = '修改失败！';            return json($result);        }    }    /**     * @param uid array     * 禁用管理员接口     */    public function defriend_admin(){        $result   = array('status' => false, 'msg' => "");        $all = Request::instance()->post();        //$all['uid'] = array('7','8','9','16');        $user = model('AdminUser');        if(sizeof($all['uid'])){            $msg = array();            $msg_defriend = array();            $msg_undefriend = array();            //循环禁用            for($i = 0; $i<sizeof($all['uid']);$i++){                $uid = $all['uid'][$i];                $user_status = $user -> where('uid',$uid) -> column('status');                //$user_list = find($user_list);                //$user_list为array()数组获取值操做                //判断UID是否可以获得数据列                if(!empty($user_status)){                    if($user_status[0] == 0){                        $defriend = 1;                        $defriend_result = $user -> where('uid='.$uid) -> setField('status',$defriend);                        if($defriend_result == false){                            array_push($msg,$uid);//添加元素                        }else{                            array_push($msg_undefriend,$uid);                        }                    }else{                        $defriend = 0;                        $defriend_result = $user -> where('uid='.$uid) -> setField('status',$defriend);                        if($defriend_result == false){                            array_push($msg,$uid);//添加元素                        }else{                            array_push($msg_defriend,$uid);                        }                    }                }else{                    array_push($msg,$uid);                }            }            //判断禁用中否出现问题            if(sizeof($msg)){                $result['status'] = 0;                $result['msg'] = 'UID为【'.implode(',',$msg).'】的数据操作失败！';                return json($result);            }else{                $result['status'] = 1;                if(empty($msg_defriend)){                    $result['msg'] = 'UID为【'.implode(',',$msg_undefriend).'】解禁成功！';                }else if(empty($msg_undefriend)){                    $result['msg'] = 'UID为【'.implode(',',$msg_defriend).'】禁用成功！';                }else{                    $result['msg'] = 'UID为【'.implode(',',$msg_defriend).'】禁用成功【'.implode(',',$msg_undefriend).'】解禁成功！';                }                return json($result);            }        }else{            //空传判断            $result['status'] = 0;            $result['msg'] = '请先选择要禁用的行！';            return json($result);        }    }    /**     * @param uid array     * 重置管理员接口     */    public function reset_admin(){        $result   = array('status' => false, 'msg' => "");        $all = Request::instance()->post();        //$all['uid'] = array('7','8','9','16');        $user = model('AdminUser');        if(sizeof($all['uid'])){            $msg = array();            //循环重置            for($i = 0; $i<sizeof($all['uid']);$i++){                $uid = $all['uid'][$i];                $reset_result = $user -> where('uid='.$uid) -> setField('pwd',authcode('888888','mysys'));                if($reset_result == false){                    array_push($msg,$uid);                }            }            //判断重置中否出现问题            if(sizeof($msg)){                $result['status'] = 0;                $result['msg'] = 'UID为【'.implode(',',$msg).'】的数据操作失败！';                return json($result);            }else{                $result['status'] = 1;                $result['msg'] = '密码重置成功！';                return json($result);            }        }else{            //空传判断            $result['status'] = 0;            $result['msg'] = '请先选择要禁用的行！';            return json($result);        }    }    /**     * @param  uid  array     * 查看用户登陆记录接口     */    public function login_list($id){        $user = model('AdminUser');        $login_list = $user -> where('uid',$id) -> column('login_info');        //json字符串转为数组，true转为可直接引用的数组，否则不可直接引用的        $list = json_decode($login_list[0], true);        if(!empty($list)) {            //根据登陆时间排序            array_multisort(array_column($list,'login_time'),SORT_DESC,$list);        }        //var_dump($list);        //echo 'ewaeawea'.$list[0]['ip'];        return view('user/loginlist',['login_list'=>$list]);    }}