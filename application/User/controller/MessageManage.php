<?php/** * Created by PhpStorm. * User: Baymax * Date: 2018/3/19 * Time: 19:55 */namespace app\user\controller;use think\Request;use think\Session;use think\Validate;Class MessageManage{    public function index(){        $result   = array('status' => false, 'msg' => "");        if (!Session::get('user_id')){            return json(array('status' => false, 'msg' => "请先登陆后再留言！"));        }        $all = Request::instance()->post();        $file = request()->file('image');        $rule = [            'contact_name'  => 'require',            'contact_email'   => 'require|email',            'contact_message' => 'require'        ];        $msg = [            'contact_name.require' => '姓名是必填的！',            'contact_email.require'  => '邮箱也是必填的！',            'contact_email.email'   => '邮箱格式有误！',            'contact_message.require' => '内容不得为空！',        ];        $validate = new Validate($rule, $msg);        $msg = $validate->check($all);        //匹配规则，如果有问题则返回输出信息        if(!$msg){            $result['status'] = 0;            $result['msg'] = $validate->getError();            return json($result);        }        //$filename = $file->getInfo()['name'];        // 移动到框架应用根目录/public/uploads/ 目录下        if($file){            $info = $file->move(ROOT_PATH . 'public' . DS . '/static/img/message/');            if($info){                // 成功上传后 获取上传信息                $message = model('Message');                $user = model('User');                $user_info = $user->where('uid',Session::get('user_id'))->select();                $root = strstr($_SERVER["SCRIPT_NAME"],'/index.php',true);                $path = 'http://'.$_SERVER["SERVER_NAME"].$root.'/static/img/message/';                $message->insert([                    'user_id'=> Session::get('user_id'),                    'name'=> $user_info[0]['name'],                    'email'=> $all['contact_email'],                    'title'=> $all['contact_name'],                    'content'=> $all['contact_message'],                    'img'=> $path.$info->getSaveName(),                    'img_name'=> $info->getSaveName(),                    'time'=> date('Y-m-d H:i:s'),                    'view_count'=> 0,                    'type'=> 0,                ]);                $result['status'] = 1;                $result['msg'] = '您的留言我们收到了！';                return json($result);            }else{                // 上传失败获取错误信息                $result['status'] = 0;                $result['msg'] = $file->getError();                return json($result);            }        }       //return json($_FILES["image"]["name"]);    }}